<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ollama Chat - Enhanced</title>
    
    <!-- External Libraries -->
    <script src="https://cdn.jsdelivr.net/npm/marked@11.0.0/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --error-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1f2937;
            --bg-secondary: #111827;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        .container {
            width: 100%;
            height: 100vh;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px 30px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            z-index: 10;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--error-color);
            animation: pulse 2s infinite;
        }

        .status-dot.connected {
            background: var(--success-color);
        }

        .token-counter {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            margin-left: 10px;
        }

        .message-tokens {
            font-size: 10px;
            color: var(--text-secondary);
            opacity: 0.7;
            margin-top: 5px;
        }

        .message-timestamp {
            font-size: 11px;
            color: var(--text-secondary);
            opacity: 0.6;
            margin-top: 8px;
            font-style: italic;
        }

        .message-reactions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            padding-top: 8px;
            border-top: 1px solid var(--border-color);
        }

        .reaction-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 4px 10px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .reaction-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: scale(1.05);
        }

        .reaction-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .reaction-count {
            font-size: 11px;
            font-weight: bold;
        }

        .regenerate-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--primary-color);
            color: var(--primary-color);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-top: 10px;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }

        .regenerate-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .icon-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            font-size: 18px;
        }

        .icon-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-2px);
        }

        .mode-selector {
            display: flex;
            gap: 10px;
        }

        .mode-btn {
            flex: 1;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 14px;
            font-weight: 600;
        }

        .mode-btn.active {
            background: white;
            color: var(--primary-color);
            border-color: white;
        }

        .config-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .input-group {
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            font-size: 12px;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .input-group input, .input-group select {
            width: 100%;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            backdrop-filter: blur(10px);
        }

        .input-group input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .input-group select {
            cursor: pointer;
        }

        .input-group select option {
            background: var(--primary-color);
            color: white;
        }

        button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary {
            background: white;
            color: var(--primary-color);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .chat-container {
            flex: 1;
            overflow-y: auto;
            padding: 30px 40px;
            background: var(--bg-secondary);
        }

        .chat-container::-webkit-scrollbar {
            width: 10px;
        }

        .chat-container::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        .chat-container::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 5px;
        }

        .chat-container::-webkit-scrollbar-thumb:hover {
            background: var(--text-secondary);
        }

        .message {
            margin-bottom: 20px;
            display: flex;
            gap: 15px;
            animation: fadeIn 0.3s;
            position: relative;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            flex-shrink: 0;
            font-size: 16px;
        }

        .message.user .message-avatar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .message.assistant .message-avatar {
            background: var(--bg-primary);
            color: var(--text-primary);
            border: 2px solid var(--border-color);
        }

        .message-content {
            flex: 1;
            padding: 15px 20px;
            border-radius: 12px;
            line-height: 1.6;
            position: relative;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
        }

        .message.assistant .message-content {
            background: var(--bg-primary);
            color: var(--text-primary);
            box-shadow: var(--shadow);
        }

        .message-content pre {
            background: #282c34;
            color: #abb2bf;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
            margin: 10px 0;
        }

        .message-content code {
            background: rgba(0, 0, 0, 0.1);
            padding: 2px 6px;
            border-radius: 4px;
            font-family: 'Monaco', 'Menlo', 'Consolas', monospace;
            font-size: 0.9em;
        }

        .message-content pre code {
            background: none;
            padding: 0;
        }

        .message-actions {
            position: absolute;
            top: 10px;
            right: 10px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .copy-btn {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid var(--border-color);
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .copy-btn:hover {
            background: white;
            transform: scale(1.05);
        }

        .copy-btn.copied {
            background: var(--success-color);
            color: white;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .message:hover .quick-actions {
            opacity: 1;
        }

        .quick-action-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text-primary);
            transition: all 0.3s;
        }

        .quick-action-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .input-container {
            padding: 20px 40px;
            background: var(--bg-primary);
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 10px;
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
        }

        .input-row {
            display: flex;
            gap: 15px;
        }

        .input-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-secondary);
            padding: 0 5px;
            min-height: 20px;
        }

        .char-count {
            opacity: 0.7;
        }

        .typing-indicator-user {
            color: var(--primary-color);
            font-weight: 500;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .typing-indicator-user.active {
            opacity: 1;
        }

        .formatting-toolbar {
            display: flex;
            gap: 5px;
            padding: 8px;
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            flex-wrap: wrap;
            margin-bottom: -2px;
        }

        .format-btn {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 5px 10px;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .format-btn:hover {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            transform: translateY(-1px);
        }

        .format-btn:active {
            transform: translateY(0);
        }

        .toolbar-divider {
            width: 1px;
            background: var(--border-color);
            margin: 0 5px;
        }

        #messageInput {
            flex: 1;
            padding: 15px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 14px;
            resize: none;
            font-family: inherit;
            transition: border-color 0.3s;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        #messageInput:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .btn-send {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 15px 30px;
            min-width: 100px;
        }

        .btn-send:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-stop {
            background: var(--error-color);
            color: white;
            padding: 15px 30px;
            min-width: 100px;
        }

        .btn-stop:hover {
            background: #dc2626;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(239, 68, 68, 0.4);
        }

        .status-message {
            text-align: center;
            padding: 20px;
            color: var(--text-secondary);
            font-style: italic;
        }

        .error-message {
            background: #fee2e2;
            color: #991b1b;
            padding: 15px 20px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid var(--error-color);
        }

        .typing-indicator {
            display: flex;
            gap: 5px;
            padding: 10px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--primary-color);
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }

        .model-info {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            padding: 4px 12px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            backdrop-filter: blur(10px);
            margin-left: 10px;
        }

        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: var(--bg-primary);
            color: var(--text-primary);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            align-items: center;
            gap: 10px;
            animation: slideIn 0.3s ease;
            z-index: 1000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--bg-primary);
            padding: 30px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        @media (max-width: 768px) {
            .config-section {
                flex-direction: column;
            }

            .input-group {
                width: 100%;
            }

            .header {
                padding: 12px 20px;
            }

            .chat-container {
                padding: 20px 15px;
            }

            .input-container {
                padding: 15px 20px;
            }

            .header h1 {
                font-size: 20px;
            }

            .status-indicator {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <h1>
                    ü§ñ Ollama Chat
                    <span class="status-indicator" id="statusIndicator">
                        <span class="status-dot" id="statusDot"></span>
                        <span id="statusText">Disconnected</span>
                    </span>
                    <span class="model-info" id="modelInfo" style="display: none;">
                        üìä <span id="currentModelName"></span>
                    </span>
                    <span class="token-counter" id="tokenCounter" style="display: none;">
                        üéØ <span id="tokenCount">0</span> tokens
                    </span>
                </h1>
                <div class="header-actions">
                    <button class="icon-btn" onclick="toggleTheme()" title="Toggle dark mode">üåì</button>
                    <button class="icon-btn" onclick="showConversationsModal()" title="Manage conversations">üí¨</button>
                    <button class="icon-btn" onclick="showExportModal()" title="Export conversation">üíæ</button>
                    <button class="icon-btn" onclick="showSettingsModal()" title="Settings">‚öôÔ∏è</button>
                    <button class="icon-btn" onclick="showShortcuts()" title="Keyboard shortcuts">‚å®Ô∏è</button>
                </div>
            </div>
            <div class="mode-selector">
                <button class="mode-btn active" id="localModeBtn" onclick="switchMode('local')">üñ•Ô∏è Local Hosting</button>
                <button class="mode-btn" id="cloudModeBtn" onclick="switchMode('cloud')">‚òÅÔ∏è Cloud Service</button>
            </div>
            <div class="config-section">
                <div class="input-group">
                    <label for="ollamaUrl">Ollama URL</label>
                    <input type="text" id="ollamaUrl" placeholder="http://localhost:11434" value="http://localhost:11434">
                </div>
                <div class="input-group" id="apiKeyGroup" style="display: none;">
                    <label for="apiKey">API Key</label>
                    <input type="password" id="apiKey" placeholder="Enter your API key">
                </div>
                <div class="input-group">
                    <label for="modelSelect">Model</label>
                    <select id="modelSelect">
                        <option value="">Select a model...</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="systemPromptSelect">System Prompt</label>
                    <select id="systemPromptSelect" onchange="handleSystemPromptChange()">
                        <option value="none">None</option>
                        <option value="coding">üíª Coding Assistant</option>
                        <option value="writing">‚úçÔ∏è Writing Helper</option>
                        <option value="learning">üìö Learning Tutor</option>
                        <option value="business">üíº Business Consultant</option>
                        <option value="creative">üé® Creative Partner</option>
                        <option value="custom">‚öôÔ∏è Custom...</option>
                    </select>
                </div>
                <button class="btn-primary" onclick="loadModels()">Load Models</button>
                <button class="btn-primary" onclick="newConversation()">üìù New</button>
                <button class="btn-primary" onclick="clearChat()">üóëÔ∏è Clear</button>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="status-message">
                üëã Welcome! Choose Local Hosting or Cloud Service, then load models to get started.
            </div>
        </div>

        <div class="input-container">
            <div class="input-info">
                <span class="typing-indicator-user" id="typingIndicator">‚úçÔ∏è Typing...</span>
                <span class="char-count" id="charCount">0 characters</span>
            </div>
            <div class="formatting-toolbar">
                <button class="format-btn" onclick="insertFormatting('**', '**')" title="Bold (Ctrl+B)"><strong>B</strong></button>
                <button class="format-btn" onclick="insertFormatting('*', '*')" title="Italic (Ctrl+I)"><em>I</em></button>
                <button class="format-btn" onclick="insertFormatting('`', '`')" title="Inline Code">&lt;/&gt;</button>
                <button class="format-btn" onclick="insertCodeBlock()" title="Code Block">{ }</button>
                <div class="toolbar-divider"></div>
                <button class="format-btn" onclick="insertFormatting('# ', '')" title="Heading 1">H1</button>
                <button class="format-btn" onclick="insertFormatting('## ', '')" title="Heading 2">H2</button>
                <button class="format-btn" onclick="insertFormatting('### ', '')" title="Heading 3">H3</button>
                <div class="toolbar-divider"></div>
                <button class="format-btn" onclick="insertFormatting('- ', '')" title="Bullet List">‚Ä¢ List</button>
                <button class="format-btn" onclick="insertFormatting('1. ', '')" title="Numbered List">1. List</button>
                <button class="format-btn" onclick="insertFormatting('> ', '')" title="Quote">‚ùù Quote</button>
                <div class="toolbar-divider"></div>
                <button class="format-btn" onclick="insertFormatting('[', '](url)')" title="Link">üîó Link</button>
                <button class="format-btn" onclick="insertFormatting('~~', '~~')" title="Strikethrough">SÃ∂</button>
            </div>
            <div class="input-row">
                <textarea 
                    id="messageInput" 
                    placeholder="Type your message here... (Shift+Enter for new line, Enter to send)" 
                    rows="1"
                    onkeydown="handleKeyPress(event)"
                    oninput="handleInputChange()"
                    style="border-radius: 0 0 8px 8px;"
                ></textarea>
                <button class="btn-send" onclick="sendMessage()" id="sendBtn">Send</button>
                <button class="btn-stop" onclick="stopGeneration()" id="stopBtn" style="display: none;">‚èπÔ∏è Stop</button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Export Conversation</h2>
                <button class="close-btn" onclick="closeModal('exportModal')">√ó</button>
            </div>
            <div style="display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-primary" onclick="exportAsText()">üìÑ Export as Text</button>
                <button class="btn-primary" onclick="exportAsMarkdown()">üìù Export as Markdown</button>
                <button class="btn-primary" onclick="exportAsJSON()">üìä Export as JSON</button>
            </div>
        </div>
    </div>

    <!-- Shortcuts Modal -->
    <div class="modal" id="shortcutsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Keyboard Shortcuts</h2>
                <button class="close-btn" onclick="closeModal('shortcutsModal')">√ó</button>
            </div>
            <div style="color: var(--text-primary);">
                <p><strong>Enter</strong> - Send message</p>
                <p><strong>Shift+Enter</strong> - New line</p>
                <p><strong>Ctrl+K</strong> - Clear chat</p>
                <p><strong>Ctrl+L</strong> - Load models</p>
                <p><strong>Ctrl+E</strong> - Export conversation</p>
                <p><strong>Ctrl+D</strong> - Toggle dark mode</p>
            </div>
        </div>
    </div>

    <!-- Custom System Prompt Modal -->
    <div class="modal" id="customPromptModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Custom System Prompt</h2>
                <button class="close-btn" onclick="closeModal('customPromptModal')">√ó</button>
            </div>
            <div>
                <textarea id="customPromptInput" 
                    style="width: 100%; min-height: 150px; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-family: inherit; color: var(--text-primary); background: var(--bg-primary);" 
                    placeholder="Enter your custom system prompt here..."></textarea>
                <div style="margin-top: 15px; display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn-primary" onclick="saveCustomPrompt()">Save</button>
                    <button class="btn-primary" onclick="closeModal('customPromptModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Conversations Management Modal -->
    <div class="modal" id="conversationsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Saved Conversations</h2>
                <button class="close-btn" onclick="closeModal('conversationsModal')">√ó</button>
            </div>
            <div>
                <div style="margin-bottom: 15px;">
                    <button class="btn-primary" onclick="showSaveConversationDialog()">üíæ Save Current Conversation</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <input type="text" id="conversationSearch" 
                        style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-family: inherit; color: var(--text-primary); background: var(--bg-primary);" 
                        placeholder="üîç Search conversations by name, model, or content..."
                        oninput="filterConversations()" />
                </div>
                <div id="conversationsList" style="max-height: 400px; overflow-y: auto; color: var(--text-primary);">
                    <!-- Conversations will be listed here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Save Conversation Dialog -->
    <div class="modal" id="saveConversationModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Save Conversation</h2>
                <button class="close-btn" onclick="closeModal('saveConversationModal')">√ó</button>
            </div>
            <div>
                <input type="text" id="conversationNameInput" 
                    style="width: 100%; padding: 10px; border: 2px solid var(--border-color); border-radius: 8px; font-family: inherit; color: var(--text-primary); background: var(--bg-primary); margin-bottom: 15px;" 
                    placeholder="Enter conversation name..." />
                <div style="display: flex; gap: 10px; justify-content: flex-end;">
                    <button class="btn-primary" onclick="saveConversation()">Save</button>
                    <button class="btn-primary" onclick="closeModal('saveConversationModal')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Settings</h2>
                <button class="close-btn" onclick="closeModal('settingsModal')">√ó</button>
            </div>
            <div style="color: var(--text-primary); max-height: 500px; overflow-y: auto;">
                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; color: var(--primary-color);">üé® Appearance</h3>
                    <div style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px;">
                        <label style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <span>Theme</span>
                            <select id="settingsTheme" onchange="applyThemeFromSettings()" style="padding: 5px; border-radius: 4px; background: var(--bg-secondary); color: var(--text-primary); border: 1px solid var(--border-color);">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                            </select>
                        </label>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; color: var(--primary-color);">üìä Statistics</h3>
                    <div style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary);">
                        <div style="margin-bottom: 8px;">Total conversations saved: <strong id="statsConversations">0</strong></div>
                        <div style="margin-bottom: 8px;">Current conversation tokens: <strong id="statsTokens">0</strong></div>
                        <div>Messages in current chat: <strong id="statsMessages">0</strong></div>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; color: var(--primary-color);">üíæ Data Management</h3>
                    <div style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; display: flex; flex-direction: column; gap: 10px;">
                        <button class="btn-primary" onclick="exportAllSettings()">üì§ Export All Settings</button>
                        <button class="btn-primary" onclick="document.getElementById('importSettingsFile').click()">üì• Import Settings</button>
                        <input type="file" id="importSettingsFile" accept=".json" style="display: none;" onchange="importSettings(this)">
                        <button class="btn-primary" onclick="clearAllData()" style="background: var(--error-color);">üóëÔ∏è Clear All Data</button>
                    </div>
                </div>

                <div style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; color: var(--primary-color);">‚ÑπÔ∏è About</h3>
                    <div style="padding: 10px; border: 1px solid var(--border-color); border-radius: 8px; background: var(--bg-secondary); font-size: 14px;">
                        <div style="margin-bottom: 5px;"><strong>Ollama Chat Enhanced</strong></div>
                        <div style="margin-bottom: 5px;">Version: 2.0</div>
                        <div style="color: var(--text-secondary);">A modern interface for chatting with Ollama models</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configure marked for markdown rendering
        marked.setOptions({
            highlight: function(code, lang) {
                if (lang && hljs.getLanguage(lang)) {
                    return hljs.highlight(code, { language: lang }).value;
                }
                return hljs.highlightAuto(code).value;
            },
            breaks: true,
            gfm: true
        });

        let conversationHistory = [];
        let isProcessing = false;
        let currentOllamaUrl = '';
        let currentModel = '';
        let currentMode = 'local';
        let currentApiKey = '';
        let draftSaveTimer = null;
        let abortController = null;
        let systemPrompt = '';
        let totalTokens = 0;
        let currentConversationId = null;

        // Conversation management
        function getSavedConversations() {
            const saved = localStorage.getItem('savedConversations');
            return saved ? JSON.parse(saved) : [];
        }

        function saveConversations(conversations) {
            localStorage.setItem('savedConversations', JSON.stringify(conversations));
        }

        function showConversationsModal() {
            loadConversationsList();
            document.getElementById('conversationSearch').value = '';
            document.getElementById('conversationsModal').classList.add('show');
        }

        function filterConversations() {
            const searchTerm = document.getElementById('conversationSearch').value.toLowerCase();
            const conversations = getSavedConversations();
            
            if (!searchTerm) {
                loadConversationsList();
                return;
            }
            
            const filtered = conversations.filter(conv => {
                // Search in name
                if (conv.name.toLowerCase().includes(searchTerm)) return true;
                
                // Search in model
                if (conv.model && conv.model.toLowerCase().includes(searchTerm)) return true;
                
                // Search in message content
                if (conv.messages && conv.messages.some(msg => 
                    msg.content.toLowerCase().includes(searchTerm)
                )) return true;
                
                return false;
            });
            
            displayFilteredConversations(filtered, searchTerm);
        }

        function displayFilteredConversations(conversations, searchTerm) {
            const listDiv = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                listDiv.innerHTML = `<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No conversations found matching "${searchTerm}"</p>`;
                return;
            }
            
            listDiv.innerHTML = conversations.map(conv => {
                const date = new Date(conv.timestamp).toLocaleString();
                return `
                    <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; background: var(--bg-secondary);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <strong style="font-size: 16px;">${highlightSearchTerm(conv.name, searchTerm)}</strong>
                            <div style="display: flex; gap: 5px;">
                                <button class="copy-btn" onclick="loadConversationById('${conv.id}')" title="Load">üìÇ Load</button>
                                <button class="copy-btn" onclick="deleteConversation('${conv.id}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            <div>üìÖ ${date}</div>
                            <div>üí¨ ${conv.messages.length} messages ‚Ä¢ üéØ ${conv.tokens || 0} tokens</div>
                            ${conv.model ? `<div>ü§ñ ${highlightSearchTerm(conv.model, searchTerm)}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function highlightSearchTerm(text, searchTerm) {
            if (!searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark style="background: var(--primary-color); color: white; padding: 2px 4px; border-radius: 3px;">$1</mark>');
        }

        function showSaveConversationDialog() {
            if (conversationHistory.length === 0) {
                showToast('‚ö†Ô∏è No conversation to save');
                return;
            }
            document.getElementById('conversationNameInput').value = '';
            document.getElementById('saveConversationModal').classList.add('show');
        }

        function saveConversation() {
            const nameInput = document.getElementById('conversationNameInput');
            const name = nameInput.value.trim();
            
            if (!name) {
                showToast('‚ö†Ô∏è Please enter a conversation name');
                return;
            }
            
            const conversations = getSavedConversations();
            const conversation = {
                id: currentConversationId || Date.now().toString(),
                name: name,
                messages: conversationHistory,
                timestamp: new Date().toISOString(),
                model: currentModel,
                systemPrompt: systemPrompt,
                tokens: totalTokens
            };
            
            // Check if updating existing conversation
            const existingIndex = conversations.findIndex(c => c.id === conversation.id);
            if (existingIndex >= 0) {
                conversations[existingIndex] = conversation;
                showToast('‚úÖ Conversation updated');
            } else {
                conversations.unshift(conversation);
                showToast('‚úÖ Conversation saved');
            }
            
            saveConversations(conversations);
            currentConversationId = conversation.id;
            closeModal('saveConversationModal');
            closeModal('conversationsModal');
        }

        function loadConversationsList() {
            const conversations = getSavedConversations();
            const listDiv = document.getElementById('conversationsList');
            
            if (conversations.length === 0) {
                listDiv.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 20px;">No saved conversations yet</p>';
                return;
            }
            
            listDiv.innerHTML = conversations.map(conv => {
                const date = new Date(conv.timestamp).toLocaleString();
                return `
                    <div style="border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; background: var(--bg-secondary);">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <strong style="font-size: 16px;">${conv.name}</strong>
                            <div style="display: flex; gap: 5px;">
                                <button class="copy-btn" onclick="loadConversationById('${conv.id}')" title="Load">üìÇ Load</button>
                                <button class="copy-btn" onclick="deleteConversation('${conv.id}')" title="Delete">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div style="font-size: 12px; color: var(--text-secondary);">
                            <div>üìÖ ${date}</div>
                            <div>üí¨ ${conv.messages.length} messages ‚Ä¢ üéØ ${conv.tokens || 0} tokens</div>
                            ${conv.model ? `<div>ü§ñ ${conv.model}</div>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function loadConversationById(id) {
            const conversations = getSavedConversations();
            const conversation = conversations.find(c => c.id === id);
            
            if (!conversation) {
                showToast('‚ùå Conversation not found');
                return;
            }
            
            // Clear current conversation
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '';
            
            // Load conversation data
            conversationHistory = conversation.messages;
            currentConversationId = conversation.id;
            totalTokens = conversation.tokens || 0;
            
            if (conversation.systemPrompt) {
                systemPrompt = conversation.systemPrompt;
            }
            
            // Display all messages
            conversationHistory.forEach(msg => {
                if (msg.role !== 'system') {
                    displayMessage(msg.role, msg.content);
                }
            });
            
            updateTokenCount();
            closeModal('conversationsModal');
            showToast(`‚úÖ Loaded: ${conversation.name}`);
        }

        function deleteConversation(id) {
            if (!confirm('Are you sure you want to delete this conversation?')) {
                return;
            }
            
            let conversations = getSavedConversations();
            conversations = conversations.filter(c => c.id !== id);
            saveConversations(conversations);
            
            if (currentConversationId === id) {
                currentConversationId = null;
            }
            
            loadConversationsList();
            showToast('üóëÔ∏è Conversation deleted');
        }

        function newConversation() {
            if (conversationHistory.length > 0) {
                if (!confirm('Start a new conversation? Current conversation will be lost if not saved.')) {
                    return;
                }
            }
            
            currentConversationId = null;
            clearChat();
            showToast('üìù New conversation started');
        }

        // Simple token estimation (rough approximation: 1 token ‚âà 4 characters)
        function estimateTokens(text) {
            return Math.ceil(text.length / 4);
        }

        const systemPromptTemplates = {
            'none': '',
            'coding': 'You are an expert programming assistant. Provide clear, well-commented code examples and explain technical concepts thoroughly.',
            'writing': 'You are a professional writing assistant. Help with grammar, style, clarity, and creative expression.',
            'learning': 'You are a patient tutor. Explain concepts step-by-step, use analogies, and encourage questions.',
            'business': 'You are a business consultant. Provide strategic, professional advice focused on practical outcomes.',
            'creative': 'You are a creative partner. Think outside the box, suggest innovative ideas, and encourage creativity.'
        };

        // Load settings from localStorage
        function loadSettings() {
            const theme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', theme);
            
            const savedMode = localStorage.getItem('mode');
            if (savedMode) {
                switchMode(savedMode);
            }
            
            // Restore draft message
            const savedDraft = localStorage.getItem('messageDraft');
            if (savedDraft) {
                document.getElementById('messageInput').value = savedDraft;
            }
            
            // Restore system prompt
            const savedPromptType = localStorage.getItem('systemPrompt');
            if (savedPromptType) {
                document.getElementById('systemPromptSelect').value = savedPromptType;
                if (savedPromptType === 'custom') {
                    systemPrompt = localStorage.getItem('customSystemPrompt') || '';
                } else {
                    systemPrompt = systemPromptTemplates[savedPromptType];
                }
            }
        }

        // Auto-save draft message
        function saveDraft() {
            const messageInput = document.getElementById('messageInput');
            localStorage.setItem('messageDraft', messageInput.value);
        }

        // Clear draft
        function clearDraft() {
            localStorage.removeItem('messageDraft');
        }

        // Handle input change (typing indicator + character count + draft save)
        let typingTimeout = null;
        function handleInputChange() {
            const messageInput = document.getElementById('messageInput');
            const charCount = document.getElementById('charCount');
            const typingIndicator = document.getElementById('typingIndicator');
            
            // Update character count
            const length = messageInput.value.length;
            charCount.textContent = `${length} character${length !== 1 ? 's' : ''}`;
            
            // Show typing indicator
            if (length > 0) {
                typingIndicator.classList.add('active');
                
                // Clear existing timeout
                if (typingTimeout) {
                    clearTimeout(typingTimeout);
                }
                
                // Hide after 1 second of no typing
                typingTimeout = setTimeout(() => {
                    typingIndicator.classList.remove('active');
                }, 1000);
            } else {
                typingIndicator.classList.remove('active');
            }
            
            // Save draft
            saveDraft();
        }

        // Save settings to localStorage
        function saveSettings() {
            localStorage.setItem('theme', document.documentElement.getAttribute('data-theme'));
            localStorage.setItem('mode', currentMode);
        }

        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            saveSettings();
            showToast(`${newTheme === 'dark' ? 'üåô' : '‚òÄÔ∏è'} ${newTheme.charAt(0).toUpperCase() + newTheme.slice(1)} mode activated`);
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        function showExportModal() {
            document.getElementById('exportModal').classList.add('show');
        }

        function showShortcuts() {
            document.getElementById('shortcutsModal').classList.add('show');
        }

        function showSettingsModal() {
            loadSettingsPanel();
            document.getElementById('settingsModal').classList.add('show');
        }

        function loadSettingsPanel() {
            // Load current settings
            const theme = document.documentElement.getAttribute('data-theme');
            document.getElementById('settingsTheme').value = theme;
            
            // Update statistics
            const conversations = getSavedConversations();
            document.getElementById('statsConversations').textContent = conversations.length;
            document.getElementById('statsTokens').textContent = totalTokens.toLocaleString();
            document.getElementById('statsMessages').textContent = conversationHistory.length;
        }

        function applyThemeFromSettings() {
            const theme = document.getElementById('settingsTheme').value;
            document.documentElement.setAttribute('data-theme', theme);
            saveSettings();
            showToast(`üé® Theme changed to ${theme}`);
        }

        function exportAllSettings() {
            const settings = {
                theme: document.documentElement.getAttribute('data-theme'),
                mode: currentMode,
                systemPrompt: localStorage.getItem('systemPrompt'),
                customSystemPrompt: localStorage.getItem('customSystemPrompt'),
                conversations: getSavedConversations(),
                exportDate: new Date().toISOString()
            };
            
            const blob = new Blob([JSON.stringify(settings, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ollama-chat-settings-${Date.now()}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showToast('üì§ Settings exported');
        }

        function importSettings(input) {
            const file = input.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const settings = JSON.parse(e.target.result);
                    
                    // Apply settings
                    if (settings.theme) {
                        document.documentElement.setAttribute('data-theme', settings.theme);
                        localStorage.setItem('theme', settings.theme);
                    }
                    
                    if (settings.mode) {
                        switchMode(settings.mode);
                    }
                    
                    if (settings.systemPrompt) {
                        localStorage.setItem('systemPrompt', settings.systemPrompt);
                    }
                    
                    if (settings.customSystemPrompt) {
                        localStorage.setItem('customSystemPrompt', settings.customSystemPrompt);
                    }
                    
                    if (settings.conversations) {
                        const existingConvos = getSavedConversations();
                        const merged = [...settings.conversations, ...existingConvos];
                        // Remove duplicates by id
                        const unique = merged.filter((conv, index, self) =>
                            index === self.findIndex((t) => t.id === conv.id)
                        );
                        saveConversations(unique);
                    }
                    
                    showToast('‚úÖ Settings imported successfully');
                    closeModal('settingsModal');
                    
                } catch (error) {
                    showToast('‚ùå Failed to import settings: ' + error.message);
                }
            };
            reader.readAsText(file);
            
            // Reset input
            input.value = '';
        }

        function clearAllData() {
            if (!confirm('‚ö†Ô∏è This will delete ALL saved conversations, settings, and data. This cannot be undone. Are you sure?')) {
                return;
            }
            
            if (!confirm('This is your last chance. Really delete everything?')) {
                return;
            }
            
            // Clear all localStorage
            localStorage.clear();
            
            // Reset current state
            conversationHistory = [];
            totalTokens = 0;
            currentConversationId = null;
            systemPrompt = '';
            
            // Reset UI
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '<div class="status-message">üí¨ All data cleared. Start fresh!</div>';
            updateTokenCount();
            
            closeModal('settingsModal');
            showToast('üóëÔ∏è All data cleared');
            
            // Reload page to reset everything
            setTimeout(() => {
                location.reload();
            }, 1500);
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function updateStatus(connected, text) {
            const dot = document.getElementById('statusDot');
            const statusText = document.getElementById('statusText');
            
            if (connected) {
                dot.classList.add('connected');
                statusText.textContent = text || 'Connected';
            } else {
                dot.classList.remove('connected');
                statusText.textContent = text || 'Disconnected';
            }
        }

        function switchMode(mode) {
            currentMode = mode;
            const localBtn = document.getElementById('localModeBtn');
            const cloudBtn = document.getElementById('cloudModeBtn');
            const apiKeyGroup = document.getElementById('apiKeyGroup');
            const ollamaUrlInput = document.getElementById('ollamaUrl');
            const apiKeyInput = document.getElementById('apiKey');

            if (mode === 'local') {
                localBtn.classList.add('active');
                cloudBtn.classList.remove('active');
                apiKeyGroup.style.display = 'none';
                ollamaUrlInput.value = 'http://localhost:11434';
                ollamaUrlInput.placeholder = 'http://localhost:11434';
            } else {
                cloudBtn.classList.add('active');
                localBtn.classList.remove('active');
                apiKeyGroup.style.display = 'block';
                ollamaUrlInput.value = 'https://ollama.com';
                ollamaUrlInput.placeholder = 'https://ollama.com';
                if (!apiKeyInput.value) {
                    apiKeyInput.value = 'b9e0d00cbcbb47adb23ae389076c7d2e.met23afbTcatGW29LdbgXSqV';
                }
            }

            document.getElementById('modelSelect').innerHTML = '<option value="">Select a model...</option>';
            updateStatus(false);
            saveSettings();
        }

        async function loadModels() {
            const ollamaUrl = document.getElementById('ollamaUrl').value.trim();
            const apiKey = document.getElementById('apiKey').value.trim();
            const modelSelect = document.getElementById('modelSelect');
            
            if (!ollamaUrl) {
                showToast('‚ö†Ô∏è Please enter an Ollama URL');
                return;
            }

            if (currentMode === 'cloud' && !apiKey) {
                showToast('‚ö†Ô∏è Please enter an API key for cloud service');
                return;
            }

            try {
                const requestBody = { ollama_url: ollamaUrl };
                if (currentMode === 'cloud' && apiKey) {
                    requestBody.api_key = apiKey;
                    currentApiKey = apiKey;
                }

                const response = await fetch('/api/models', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody)
                });

                const data = await response.json();

                if (data.success) {
                    modelSelect.innerHTML = '<option value="">Select a model...</option>';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        modelSelect.appendChild(option);
                    });

                    if (data.models.length === 0) {
                        showToast('‚ö†Ô∏è No models found on this Ollama instance');
                    } else {
                        currentOllamaUrl = ollamaUrl;
                        updateStatus(true, `${data.models.length} models available`);
                        showToast(`‚úÖ Loaded ${data.models.length} model(s)`);
                    }
                } else {
                    showToast('‚ùå Error: ' + data.error);
                    updateStatus(false);
                }
            } catch (error) {
                showToast('‚ùå Failed to load models: ' + error.message);
                updateStatus(false);
            }
        }

        // Model selection change handler
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('modelSelect').addEventListener('change', function(e) {
                const modelName = e.target.value;
                const modelInfo = document.getElementById('modelInfo');
                const currentModelName = document.getElementById('currentModelName');
                
                if (modelName) {
                    currentModelName.textContent = modelName;
                    modelInfo.style.display = 'inline-flex';
                } else {
                    modelInfo.style.display = 'none';
                }
            });

            loadSettings();
        });

        function handleSystemPromptChange() {
            const select = document.getElementById('systemPromptSelect');
            const value = select.value;
            
            if (value === 'custom') {
                const customPromptInput = document.getElementById('customPromptInput');
                customPromptInput.value = systemPrompt || '';
                document.getElementById('customPromptModal').classList.add('show');
            } else {
                systemPrompt = systemPromptTemplates[value];
                localStorage.setItem('systemPrompt', value);
                if (systemPrompt) {
                    showToast(`‚úÖ System prompt set: ${select.options[select.selectedIndex].text}`);
                } else {
                    showToast('üîÑ System prompt cleared');
                }
            }
        }

        function saveCustomPrompt() {
            const customPromptInput = document.getElementById('customPromptInput');
            systemPrompt = customPromptInput.value.trim();
            localStorage.setItem('customSystemPrompt', systemPrompt);
            localStorage.setItem('systemPrompt', 'custom');
            closeModal('customPromptModal');
            showToast('‚úÖ Custom system prompt saved');
        }

        function updateTokenCount() {
            totalTokens = 0;
            conversationHistory.forEach(msg => {
                totalTokens += estimateTokens(msg.content);
            });
            
            const tokenCounter = document.getElementById('tokenCounter');
            const tokenCount = document.getElementById('tokenCount');
            
            tokenCount.textContent = totalTokens.toLocaleString();
            
            if (totalTokens > 0) {
                tokenCounter.style.display = 'inline-flex';
            } else {
                tokenCounter.style.display = 'none';
            }
        }

        function formatTimestamp(isoString) {
            const date = new Date(isoString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return date.toLocaleString('en-US', { 
                month: 'short', 
                day: 'numeric', 
                hour: 'numeric', 
                minute: '2-digit',
                hour12: true 
            });
        }

        function toggleReaction(button, reactionType) {
            const countSpan = button.querySelector('.reaction-count');
            let count = parseInt(countSpan.textContent);
            
            if (button.classList.contains('active')) {
                button.classList.remove('active');
                count = Math.max(0, count - 1);
            } else {
                button.classList.add('active');
                count++;
            }
            
            countSpan.textContent = count;
            
            // Store reaction in message data attribute
            const messageDiv = button.closest('.message');
            const reactions = JSON.parse(messageDiv.getAttribute('data-reactions') || '{}');
            reactions[reactionType] = { count, active: button.classList.contains('active') };
            messageDiv.setAttribute('data-reactions', JSON.stringify(reactions));
            
            showToast(`Reaction ${button.classList.contains('active') ? 'added' : 'removed'}`);
        }

        function updateRegenerateButtons() {
            // Remove all existing regenerate buttons
            document.querySelectorAll('.regenerate-btn').forEach(btn => btn.remove());
            
            // Find all assistant messages
            const assistantMessages = document.querySelectorAll('.message.assistant');
            if (assistantMessages.length === 0) return;
            
            // Add regenerate button only to the last assistant message
            const lastMessage = assistantMessages[assistantMessages.length - 1];
            const contentWrapper = lastMessage.querySelector('div[style*="flex"]');
            
            if (contentWrapper && !contentWrapper.querySelector('.regenerate-btn')) {
                const regenerateBtn = document.createElement('button');
                regenerateBtn.className = 'regenerate-btn';
                regenerateBtn.innerHTML = 'üîÑ Regenerate';
                regenerateBtn.onclick = regenerateLastResponse;
                contentWrapper.appendChild(regenerateBtn);
            }
        }

        async function regenerateLastResponse() {
            // Find the last user message
            const messages = document.querySelectorAll('.message');
            let lastUserMessage = null;
            let lastAssistantMessage = null;
            
            for (let i = messages.length - 1; i >= 0; i--) {
                if (messages[i].classList.contains('assistant') && !lastAssistantMessage) {
                    lastAssistantMessage = messages[i];
                }
                if (messages[i].classList.contains('user') && !lastUserMessage) {
                    lastUserMessage = messages[i];
                    break;
                }
            }
            
            if (!lastUserMessage || !lastAssistantMessage) {
                showToast('‚ö†Ô∏è Cannot regenerate');
                return;
            }
            
            // Get the user's message content
            const userContent = lastUserMessage.querySelector('.message-content').textContent;
            
            // Remove the last assistant message from DOM and history
            lastAssistantMessage.remove();
            if (conversationHistory.length > 0 && conversationHistory[conversationHistory.length - 1].role === 'assistant') {
                conversationHistory.pop();
            }
            
            // Show typing indicator
            const typingDiv = showTypingIndicator();
            showToast('üîÑ Regenerating response...');
            
            // Resend the message
            try {
                const requestBody = {
                    ollama_url: currentOllamaUrl,
                    model: currentModel,
                    messages: conversationHistory,
                    api_key: currentApiKey
                };

                abortController = new AbortController();
                
                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to get response');
                }

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = '';
                let messageDiv = null;

                while (true) {
                    const { value, done } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const data = JSON.parse(line.slice(6));
                                if (data.content) {
                                    fullResponse += data.content;
                                    
                                    if (!messageDiv) {
                                        typingDiv.remove();
                                        messageDiv = document.createElement('div');
                                        messageDiv.className = 'message assistant';
                                        messageDiv.setAttribute('data-timestamp', new Date().toISOString());
                                        
                                        const avatar = document.createElement('div');
                                        avatar.className = 'message-avatar';
                                        avatar.textContent = 'ü§ñ';
                                        
                                        const contentWrapper = document.createElement('div');
                                        contentWrapper.style.flex = '1';
                                        
                                        const contentDiv = document.createElement('div');
                                        contentDiv.className = 'message-content';
                                        contentWrapper.appendChild(contentDiv);
                                        
                                        messageDiv.appendChild(avatar);
                                        messageDiv.appendChild(contentWrapper);
                                        
                                        document.getElementById('chatContainer').appendChild(messageDiv);
                                    }
                                    
                                    updateMessageContent(messageDiv, fullResponse);
                                }
                            } catch (e) {
                                // Ignore parse errors
                            }
                        }
                    }
                }

                conversationHistory.push({
                    role: 'assistant',
                    content: fullResponse
                });
                
                updateTokenCount();
                updateRegenerateButtons();
                showToast('‚úÖ Response regenerated');

            } catch (error) {
                typingDiv.remove();
                if (error.name === 'AbortError') {
                    showToast('‚èπÔ∏è Generation stopped');
                } else {
                    displayError('Failed to regenerate: ' + error.message);
                }
            } finally {
                abortController = null;
            }
        }

        function clearChat() {
            if (conversationHistory.length > 0) {
                if (!confirm('Clear this conversation? This action cannot be undone.')) {
                    return;
                }
            }
            
            conversationHistory = [];
            totalTokens = 0;
            currentConversationId = null;
            const chatContainer = document.getElementById('chatContainer');
            chatContainer.innerHTML = '<div class="status-message">üí¨ Chat cleared. Start a new conversation!</div>';
            updateTokenCount();
            showToast('üóëÔ∏è Chat cleared');
        }

        function insertFormatting(before, after) {
            const textarea = document.getElementById('messageInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);
            
            textarea.value = beforeText + before + selectedText + after + afterText;
            
            // Set cursor position
            const newCursorPos = start + before.length + selectedText.length;
            textarea.focus();
            textarea.setSelectionRange(newCursorPos, newCursorPos);
            
            // Trigger input event for draft save
            handleInputChange();
            showToast('‚ú® Formatting applied');
        }

        function insertCodeBlock() {
            const textarea = document.getElementById('messageInput');
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            const beforeText = textarea.value.substring(0, start);
            const afterText = textarea.value.substring(end);
            
            const codeBlock = '```\n' + (selectedText || 'code here') + '\n```';
            textarea.value = beforeText + codeBlock + afterText;
            
            // Set cursor position inside the code block
            const newCursorPos = start + 4; // After ```\n
            textarea.focus();
            textarea.setSelectionRange(newCursorPos, newCursorPos + (selectedText || 'code here').length);
            
            handleInputChange();
            showToast('‚ú® Code block inserted');
        }

        function handleKeyPress(event) {
            // Ctrl+K - Clear chat
            if (event.ctrlKey && event.key === 'k') {
                event.preventDefault();
                clearChat();
            }
            // Ctrl+L - Load models
            if (event.ctrlKey && event.key === 'l') {
                event.preventDefault();
                loadModels();
            }
            // Ctrl+E - Export
            if (event.ctrlKey && event.key === 'e') {
                event.preventDefault();
                showExportModal();
            }
            // Ctrl+D - Toggle dark mode
            if (event.ctrlKey && event.key === 'd') {
                event.preventDefault();
                toggleTheme();
            }
            // Ctrl+B - Bold
            if (event.ctrlKey && event.key === 'b') {
                event.preventDefault();
                insertFormatting('**', '**');
            }
            // Ctrl+I - Italic
            if (event.ctrlKey && event.key === 'i') {
                event.preventDefault();
                insertFormatting('*', '*');
            }
            // Enter - Send message
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        async function sendMessage() {
            if (isProcessing) return;

            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            const modelSelect = document.getElementById('modelSelect');
            const model = modelSelect.value;

            if (!message) return;

            if (!currentOllamaUrl) {
                showToast('‚ö†Ô∏è Please load models first');
                return;
            }

            if (!model) {
                showToast('‚ö†Ô∏è Please select a model');
                return;
            }

            currentModel = model;
            isProcessing = true;
            document.getElementById('sendBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'block';

            messageInput.value = '';
            clearDraft(); // Clear saved draft

            // Add system prompt if set and conversation is empty
            if (systemPrompt && conversationHistory.length === 0) {
                conversationHistory.push({
                    role: 'system',
                    content: systemPrompt
                });
            }

            conversationHistory.push({
                role: 'user',
                content: message
            });

            displayMessage('user', message);
            updateTokenCount();

            const typingDiv = showTypingIndicator();

            try {
                const requestBody = {
                    ollama_url: currentOllamaUrl,
                    model: currentModel,
                    messages: conversationHistory
                };

                if (currentMode === 'cloud' && currentApiKey) {
                    requestBody.api_key = currentApiKey;
                }

                // Create new AbortController for this request
                abortController = new AbortController();

                const response = await fetch('/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(requestBody),
                    signal: abortController.signal
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                typingDiv.remove();

                const assistantMessageDiv = createMessageDiv('assistant');
                let fullResponse = '';

                const reader = response.body.getReader();
                const decoder = new TextDecoder();

                while (true) {
                    const { done, value } = await reader.read();
                    
                    if (done) break;

                    const chunk = decoder.decode(value);
                    const lines = chunk.split('\n');

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            const jsonStr = line.substring(6);
                            try {
                                const data = JSON.parse(jsonStr);
                                
                                if (data.error) {
                                    throw new Error(data.error);
                                }

                                if (data.message && data.message.content) {
                                    fullResponse += data.message.content;
                                    updateMessageContent(assistantMessageDiv, fullResponse);
                                }
                            } catch (e) {
                                if (e.message.includes('Ollama') || e.message.includes('request')) {
                                    throw e;
                                }
                            }
                        }
                    }
                }

                conversationHistory.push({
                    role: 'assistant',
                    content: fullResponse
                });
                
                updateTokenCount();

            } catch (error) {
                typingDiv.remove();
                if (error.name === 'AbortError') {
                    showToast('‚èπÔ∏è Generation stopped');
                } else {
                    displayError('Failed to get response: ' + error.message);
                    showToast('‚ùå Error: ' + error.message);
                }
            } finally {
                isProcessing = false;
                document.getElementById('sendBtn').style.display = 'block';
                document.getElementById('stopBtn').style.display = 'none';
                abortController = null;
                messageInput.focus();
            }
        }

        function stopGeneration() {
            if (abortController) {
                abortController.abort();
                showToast('‚èπÔ∏è Stopping generation...');
            }
        }

        function displayMessage(role, content) {
            const chatContainer = document.getElementById('chatContainer');
            
            const statusMsg = chatContainer.querySelector('.status-message');
            if (statusMsg) {
                statusMsg.remove();
            }

            const messageDiv = createMessageDiv(role);
            updateMessageContent(messageDiv, content);
        }

        function createMessageDiv(role) {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.setAttribute('data-timestamp', new Date().toISOString());

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = role === 'user' ? 'üë§' : 'ü§ñ';

            const contentWrapper = document.createElement('div');
            contentWrapper.style.flex = '1';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';

            contentWrapper.appendChild(contentDiv);
            
            // Add timestamp
            const timestampDiv = document.createElement('div');
            timestampDiv.className = 'message-timestamp';
            timestampDiv.textContent = formatTimestamp(new Date().toISOString());
            contentWrapper.appendChild(timestampDiv);

            const actionsDiv = document.createElement('div');
            actionsDiv.className = 'message-actions';
            if (role === 'user') {
                actionsDiv.innerHTML = `
                    <button class="copy-btn" onclick="copyMessage(this)">üìã Copy</button>
                    <button class="copy-btn" onclick="editMessage(this)">‚úèÔ∏è Edit</button>
                `;
            } else {
                actionsDiv.innerHTML = '<button class="copy-btn" onclick="copyMessage(this)">üìã Copy</button>';
            }
            
            // Add quick actions for assistant messages
            if (role === 'assistant') {
                const quickActionsDiv = document.createElement('div');
                quickActionsDiv.className = 'quick-actions';
                quickActionsDiv.innerHTML = `
                    <button class="quick-action-btn" onclick="quickAction(this, 'explain')">üí° Explain more</button>
                    <button class="quick-action-btn" onclick="quickAction(this, 'simplify')">‚ú® Simplify</button>
                    <button class="quick-action-btn" onclick="quickAction(this, 'example')">üìù Show example</button>
                    <button class="quick-action-btn" onclick="quickAction(this, 'alternative')">üîÑ Give alternatives</button>
                `;
                contentWrapper.appendChild(quickActionsDiv);
                
                // Add reactions
                const reactionsDiv = document.createElement('div');
                reactionsDiv.className = 'message-reactions';
                reactionsDiv.innerHTML = `
                    <button class="reaction-btn" onclick="toggleReaction(this, 'thumbs-up')">üëç <span class="reaction-count">0</span></button>
                    <button class="reaction-btn" onclick="toggleReaction(this, 'thumbs-down')">üëé <span class="reaction-count">0</span></button>
                    <button class="reaction-btn" onclick="toggleReaction(this, 'heart')">‚ù§Ô∏è <span class="reaction-count">0</span></button>
                `;
                contentWrapper.appendChild(reactionsDiv);
                
                // Update regenerate buttons after message is added
                setTimeout(() => {
                    updateRegenerateButtons();
                }, 0);
            }

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentWrapper);
            messageDiv.appendChild(actionsDiv);
            chatContainer.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;

            return messageDiv;
        }

        function quickAction(button, action) {
            const messageDiv = button.closest('.message');
            const content = messageDiv.querySelector('.message-content').textContent;
            
            const prompts = {
                'explain': `Please explain this in more detail:\n\n${content}`,
                'simplify': `Please simplify and explain this in simpler terms:\n\n${content}`,
                'example': `Please provide a practical example for:\n\n${content}`,
                'alternative': `Please provide alternative approaches or perspectives on:\n\n${content}`
            };
            
            const messageInput = document.getElementById('messageInput');
            messageInput.value = prompts[action];
            messageInput.focus();
            handleInputChange();
            showToast(`‚ú® Quick action applied: ${action}`);
        }

        function updateMessageContent(messageDiv, content) {
            const contentDiv = messageDiv.querySelector('.message-content');
            
            // Render markdown for assistant messages
            if (messageDiv.classList.contains('assistant')) {
                contentDiv.innerHTML = marked.parse(content);
            } else {
                contentDiv.textContent = content;
            }
            
            // Add token count to message
            const tokens = estimateTokens(content);
            let tokenSpan = contentDiv.parentElement.querySelector('.message-tokens');
            if (!tokenSpan) {
                tokenSpan = document.createElement('div');
                tokenSpan.className = 'message-tokens';
                contentDiv.parentElement.appendChild(tokenSpan);
            }
            tokenSpan.textContent = `~${tokens} tokens`;

            const chatContainer = document.getElementById('chatContainer');
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function copyMessage(button) {
            const messageContent = button.closest('.message').querySelector('.message-content').textContent;
            navigator.clipboard.writeText(messageContent).then(() => {
                button.textContent = '‚úÖ Copied!';
                button.classList.add('copied');
                setTimeout(() => {
                    button.textContent = 'üìã Copy';
                    button.classList.remove('copied');
                }, 2000);
            });
        }

        function editMessage(button) {
            const messageDiv = button.closest('.message');
            const messageContent = messageDiv.querySelector('.message-content');
            const originalText = messageContent.textContent;
            
            // Get the index of this message in the chat
            const chatContainer = document.getElementById('chatContainer');
            const messages = Array.from(chatContainer.querySelectorAll('.message'));
            const messageIndex = messages.indexOf(messageDiv);
            
            // Create textarea for editing
            const textarea = document.createElement('textarea');
            textarea.value = originalText;
            textarea.style.cssText = 'width: 100%; min-height: 80px; padding: 10px; border: 2px solid var(--primary-color); border-radius: 8px; font-family: inherit; font-size: 14px; resize: vertical;';
            
            // Create save/cancel buttons
            const buttonContainer = document.createElement('div');
            buttonContainer.style.cssText = 'display: flex; gap: 10px; margin-top: 10px;';
            buttonContainer.innerHTML = `
                <button class="copy-btn" onclick="saveEditedMessage(this, ${messageIndex}, '${originalText.replace(/'/g, "\\'")}')">üíæ Save</button>
                <button class="copy-btn" onclick="cancelEdit(this, '${originalText.replace(/'/g, "\\'")}')">‚ùå Cancel</button>
            `;
            
            // Replace content with editor
            messageContent.innerHTML = '';
            messageContent.appendChild(textarea);
            messageContent.appendChild(buttonContainer);
            textarea.focus();
        }

        function cancelEdit(button, originalText) {
            const messageContent = button.closest('.message-content');
            messageContent.textContent = originalText.replace(/\\'/g, "'");
        }

        function saveEditedMessage(button, messageIndex, originalText) {
            const messageContent = button.closest('.message-content');
            const textarea = messageContent.querySelector('textarea');
            const newText = textarea.value.trim();
            
            if (!newText) {
                showToast('‚ö†Ô∏è Message cannot be empty');
                return;
            }
            
            if (newText === originalText) {
                cancelEdit(button, originalText);
                return;
            }
            
            // Update conversation history
            // Find the user message index in conversation history (skip system messages)
            let userMessageCount = 0;
            for (let i = 0; i < conversationHistory.length; i++) {
                if (conversationHistory[i].role === 'user') {
                    if (userMessageCount === Math.floor(messageIndex / 2)) {
                        conversationHistory[i].content = newText;
                        // Remove all messages after this one
                        conversationHistory = conversationHistory.slice(0, i + 1);
                        break;
                    }
                    userMessageCount++;
                }
            }
            
            // Update display
            messageContent.textContent = newText;
            
            // Remove all messages after the edited one
            const chatContainer = document.getElementById('chatContainer');
            const messages = Array.from(chatContainer.querySelectorAll('.message'));
            for (let i = messageIndex + 1; i < messages.length; i++) {
                messages[i].remove();
            }
            
            showToast('‚úÖ Message edited. Send a new message to continue.');
        }

        function showTypingIndicator() {
            const chatContainer = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message assistant';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = 'ü§ñ';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            
            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.innerHTML = '<span></span><span></span><span></span>';
            
            contentDiv.appendChild(typingIndicator);
            messageDiv.appendChild(avatar);
            messageDiv.appendChild(contentDiv);
            chatContainer.appendChild(messageDiv);

            chatContainer.scrollTop = chatContainer.scrollHeight;

            return messageDiv;
        }

        function displayError(message) {
            const chatContainer = document.getElementById('chatContainer');
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            chatContainer.appendChild(errorDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function exportAsText() {
            const text = conversationHistory.map(msg => 
                `${msg.role.toUpperCase()}:\n${msg.content}\n\n`
            ).join('---\n\n');
            
            downloadFile('conversation.txt', text);
            closeModal('exportModal');
            showToast('üíæ Exported as text');
        }

        function exportAsMarkdown() {
            const markdown = conversationHistory.map(msg => 
                `## ${msg.role === 'user' ? 'üë§ User' : 'ü§ñ Assistant'}\n\n${msg.content}\n\n`
            ).join('---\n\n');
            
            downloadFile('conversation.md', markdown);
            closeModal('exportModal');
            showToast('üíæ Exported as markdown');
        }

        function exportAsJSON() {
            const json = JSON.stringify({
                model: currentModel,
                timestamp: new Date().toISOString(),
                conversation: conversationHistory
            }, null, 2);
            
            downloadFile('conversation.json', json);
            closeModal('exportModal');
            showToast('üíæ Exported as JSON');
        }

        function downloadFile(filename, content) {
            const blob = new Blob([content], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
    </script>
</body>
</html>

